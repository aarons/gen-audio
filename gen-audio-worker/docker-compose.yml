# Docker Compose for gen-audio-worker
#
# Usage:
#   GPU mode:    docker compose up
#   CPU only:    docker compose -f docker-compose.yml -f docker-compose.cpu.yml up
#
# After starting, add the worker to your coordinator:
#   ./gen-audio workers add local localhost -p 2222

services:
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "2222:22"
    environment:
      - PYTORCH_ENABLE_MPS_FALLBACK=1
    volumes:
      # Mount SSH public key for authentication
      - ~/.ssh/id_rsa.pub:/root/.ssh/authorized_keys:ro
      # Mount voice references directory
      - ./voices:/root/.gen-audio/worker/voices:ro
      # Mount output directory for testing
      - ./output:/root/.gen-audio/worker/output
      # Cache model weights between restarts
      - model-cache:/root/.cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "sh", "-c", "gen-audio-worker status | python -c \"import sys, json; d=json.load(sys.stdin); sys.exit(0 if d.get('ready') else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Model loading takes time

volumes:
  model-cache:
